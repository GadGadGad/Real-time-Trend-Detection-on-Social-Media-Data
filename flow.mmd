flowchart TD
    %% 1. DATA COLLECTION LAYER
    subgraph S1["1. DATA COLLECTION (Multi-source)"]
        direction TB
        G[Google Trends CSV] --> |Keywords| RAW_T[Raw Trends List]
        FB[Facebook Pages] --> |Apify/Graph API| RAW_F[JSON Data]
        NEWS[News Sites] --> |Scrapers| RAW_N[CSV Data]
    end

    %% 2. PREPROCESSING & ENRICHMENT
    subgraph S2["2. PREPROCESSING & NLP ENRICHMENT"]
        direction TB
        RAW_F & RAW_N --> CLEAN[Clean Text & Unicode Standardize]
        
        CLEAN --> NER[Named Entity Recognition<br/>(underthesea)]
        NER --> |Extract PER/LOC/ORG| ENRICHED[Enriched Text]
        
        RAW_T --> ALIAS[Build Alias Dict<br/>(Google Trends)]
        ALIAS --> |Expand Keywords| NORM[Alias Normalization]
        
        ENRICHED --> NORM
    end

    %% 3. ANALYSIS CORE
    subgraph S3["3. ANALYSIS CORE"]
        direction TB
        NORM --> EMB[Embedding Model<br/>(PhoBERT/mpnet-multilingual)]
        
        EMB --> MATCH[Semantic Matching<br/>(Cosine Similarity)]
        
        MATCH --> DUAL{Strategy?}
        
        DUAL --> |Primary: Known Trends| BEST[Assign to Best Trend]
        DUAL --> |Secondary: Discovery| CLUST["Clustering (UMAP + HDBSCAN)<br/>⚠️ Issues: Noise & Overlap"]
        
        style CLUST stroke-dasharray: 5 5,fill:#fff4e6,stroke:#ff9900
        
        BEST --> TOPICS[Unified Topics]
        CLUST -.-> |Experimental| TOPICS
    end

    %% 4. SCORING & CLASSIFICATION
    subgraph S4["4. SCORING & EVALUATION"]
        TOPICS --> SCORE[Trend Scoring Formula]
        
        SCORE --> CALC[T = w1*G + w2*F + w3*N]
        note["G: Search Volume<br>F: FB Engagement (Interaction/Time)<br>N: News Coverage Density"]
        CALC -.-> note
        
        CALC --> CLASS{Classification}
        CLASS --> T1[Social Controversy]
        CLASS --> T2[Civil Unrest]
        CLASS --> T3[Viral Lifestyle]
        CLASS --> T4[Natural Disaster]
        CLASS --> T5[Others...]
    end

    %% 5. OUTPUT
    subgraph S5["5. OUTPUT"]
        T1 & T2 & T3 & T4 & T5 --> DASH[Real-time Dashboard]
        DASH --> ALERT[Alerts System]
    end

    %% Connect layers
    S1 --> S2
    S2 --> S3
    S3 --> S4
    S4 --> S5